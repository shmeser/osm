# Геоданные регионов, районов, населённых пунктов

## Про OSM
Открытые данные по городам, странам и прочим географическим объектам можно получить из https://openstreetmap.org/

Различные инструкции есть в вики
https://wiki.openstreetmap.org/

С помощью открытых геоданных OSM можно поднять собственный картографический сервис. Или же использовать различные выборки для своих нужд.

Далее описана инструкция про получение данных по административно-территориальным единицам государства, а конкретно РФ.

Вся база OSM занимает в сжатом виде около 80Гб, в распакованном - около 1Тб

Для сбора данных по РФ можно использовать конкретные локальные выборки, которые можно скачать на http://download.geofabrik.de/

Использовать будем файлы с расширением `.pbf`

Стоит учесть, что масштабы РФ огромны, территория пересекает 180 меридиан и уходит в другое полушарие. 

```
Скачанные с geofabrik.de pbf файлы не позволяют получать зоны, разделённые 180 меридианом.
Иногда в экстрактах не попадаются граничные пути (ways), поэтому нужно объединить экстракт с другим, смежным.
https://help.openstreetmap.org/questions/67534/osm2pgsql-does-not-build-geometries-for-objects-with-dateline-crossing
```

Поэтому стоит объединить данные по РФ с данными граничащего на 180 меридиане государства - США.

Два экстракта нужно объединить для дальнейшей работы.

Для объединения данных используем `osmosis`

https://wiki.openstreetmap.org/wiki/Osmosis#Downloading

## Объединяем дампы перед загрузкой 
`(объединять в один можно только 2 файла, не больше)`

Скачиваем последние экстракты по РФ и США - russia-latest.osm.pbf и usa-latest.osm.pbf соответственно.

Выполняем команду в консоли:
```
osmosis --read-pbf russia-latest.osm.pbf --read-pbf usa-latest.osm.pbf --merge --write-pbf russia-usa.osm.pbf
```
>Total execution time: 2673012 milliseconds.
На выходе получим данные по РФ и США в файле `russia-usa.osm.pbf`


## Выполняем вычленение данных из сжатого файла

Используем утилиту `osm2pgsql`

https://osm2pgsql.org/

Она позволяет достать нужные данные из `pbf` файлов согласно алгоритму, описанному на `lua`, код находится в файле `fetch_from_osm.lua`

Перед запуском `osm2pgsql` необходимо создать нужную базу данных в Postgres и выполнить предварительный SQL-скрипт `recreate_app_geo_tables.sql`, который добавит нужные расширения и таблицы с префиксом `app_geo__` для итоговых данных.

Выполняем скрипт
```
osm2pgsql -O flex -S .\fetch_from_osm.lua .\russia-usa.osm.pbf --database=postgresql://postgres:postgres@localhost:5432/osm
```

**Для России+США выполнение скрипта расходует 15Гб ОЗУ**

Краткий лог выполнения на 8/16 ядрах и 32Гб ОЗУ

```
2022-07-11 15:45:48    Reading input files done in 310s (5m 10s).
2022-07-11 15:45:48    Processed 1564423927 nodes in 83s (1m 23s) - 18848k/s
2022-07-11 15:45:48    Processed 149587664 ways in 209s (3m 29s) - 716k/s
2022-07-11 15:45:48    Processed 2072444 relations in 18s - 115k/s
```

После окончания обработки нужно выполнить SQL-скрипт `start_loading_geo_data.sql`, который добавит данные в итоговые таблицы.

### Визуально посмотреть полученный результат можно с помощью QGIS

https://qgis.org/ru/site/

В настройках подключается нужная БД и выбирается таблица с геоданными. Вдобавок можно подключить растровый слой карты, на котором будет гораздо информативнее просматривать загруженные объекты.